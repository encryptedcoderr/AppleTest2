#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>

#include <linux/wireless.h>

int fd = -1;

int get_generic_socket() {
    if (fd != -1) {
        return fd;
    }
    fd = socket(AF_INET, SOCK_DGRAM, 0);
    if (fd < 0) {
        printf("unable to get AF_INET socket...\n");
    }
    return fd;
}

void set_power(char* interface_name, int power_level) {
    int fd = get_generic_socket();
    struct iwreq req = {0};

    strncpy(req.ifr_name, interface_name, IFNAMSIZ);

    req.u.txpower.value = power_level;
    req.u.txpower.fixed = 1;
    req.u.txpower.flags = 0; // value is is dBm

    int err = ioctl(fd, SIOCSIWTXPOW, &req);
    //printf("ioctl returned %d\n", err);
}

int get_power(char* interface_name) {
    int fd = get_generic_socket();
    struct iwreq req = {0};

    strncpy(req.ifr_name, interface_name, IFNAMSIZ);

    req.u.txpower.value = -1;
    req.u.txpower.fixed = 1;
    req.u.txpower.flags = 0; // value is is dBm

    int err = ioctl(fd, SIOCGIWTXPOW, &req);
    //printf("ioctl returned %d\n", err);
    //printf("level: %d\n", req.u.txpower.value);
    return req.u.txpower.value;
}

int main(int argc, char** argv) {
    if (argc < 2) {
        printf("usage: set_and_get_power interface_name\n");
        return 0; 
    }

    char* interface_name = argv[1];

    for (int power_level = 30; power_level > 10; power_level--) {
        set_power(interface_name, power_level);
        /*
        int read_level = get_power(interface_name);
        int n_reads = 1;
        while (read_level != power_level) {
            read_level = get_power(interface_name);
            n_reads++;
        }
        printf("took %d reads for levels to match\n", n_reads);
        */
        printf("did set\n");
    }
    

    return 0;
}
