#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

#include <bluetooth/bluetooth.h>
#include <bluetooth/hci.h>
#include <bluetooth/hci_lib.h>

/* BlueZ socket */
int handle = 0;
int init_btle(char* dev_name) {
  int err;
  int dev_id = hci_devid(dev_name);

  if (dev_id < 0) {
    perror("invalid bluetooth device");
    return 0;
  }

  printf("got device id %d for %s\n", dev_id, dev_name);

  /* open handle */
  handle = hci_open_dev(dev_id);
  if (handle < 0) {
    perror("unable to open device");
    return 0;
  }

  /* get device info */
  struct hci_dev_info di = {0};
  err = hci_devinfo(dev_id, &di);
  if (err < 0) {
    printf("failed to get device info\n");
    hci_close_dev(handle);
    return 0;
  }

  /* get version info */
  struct hci_version ver = {0};
  err = hci_read_local_version(handle, &ver, 1000);
  if (err < 0) {
    perror("failed to read version info");
    hci_close_dev(handle);
    return 0;
  }

  printf("got socket for BTLE device %s (%d)\n", dev_name, handle);
  printf("  manufacturer: %s (%04x)\n", bt_compidtostr(ver.manufacturer), ver.manufacturer);

  char addr_str[32] = {0};
  ba2str(&di.bdaddr, addr_str);
  printf("  MAC: %s\n", addr_str);

  return 1;
}

void fini_btle() {
  hci_close_dev(handle);
  handle = 0;
}

int start_advertising_hashes(uint8_t* hash1, uint8_t* hash2, uint8_t* hash3, uint8_t* hash4) {
  int err;
  /* set advertising parameters */
  le_set_advertising_parameters_cp params = {0};

  params.min_interval = 200;
  params.max_interval = 200;
  params.advtype = 0;
  params.own_bdaddr_type = 0;
  params.direct_bdaddr_type = 0;
  //params.direct_bdaddr = {{0,0,0,0,0,0}};
  params.chan_map = 0x07; // all advertising channels
  params.filter = 0;

  err = hci_send_cmd(handle, OGF_LE_CTL, OCF_LE_SET_ADVERTISING_PARAMETERS, sizeof(params), &params);
  if (err < 0) {
    perror("failed to set LE advertising parameters");
    hci_close_dev(handle);
    return 0;
  }

  printf("set advertising params!\n");


  /* enable advertising */
  le_set_advertise_enable_cp enable = {0};
  enable.enable = 1;

  err = hci_send_cmd(handle, OGF_LE_CTL, OCF_LE_SET_ADVERTISE_ENABLE, sizeof(enable), &enable);
  if (err < 0) {
    perror("failed to enable LE advertising");
    hci_close_dev(handle);
    return 0;
  }
  printf("LE advertising enabled!\n");

  /* set payload */
  uint8_t payload[] = {0x02, 0x01, 0x06,
                       0x17,
                       0xff,
                       0x4c, 0x00, 
                       0x05, 
                       0x12, 
                       0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 

                       hash1[0], hash1[1],
                       hash2[0], hash2[1],
                       hash3[0], hash3[1],
                       hash4[0], hash4[1],

                       0x00};

  le_set_advertising_data_cp data = {0};
  data.length = sizeof(payload);
  memcpy(data.data, payload, sizeof(payload));
  err = hci_send_cmd(handle, OGF_LE_CTL, OCF_LE_SET_ADVERTISING_DATA, sizeof(payload)+1, &data);
  if (err < 0) {
    perror("failed to set LE advertising data");
    hci_close_dev(handle);
    return 0;
  }
  printf("advertising following payload via BTLE: ");
  for (int i = 0; i < sizeof(payload); i++) {
    printf("%02x", payload[i]);
  }
  printf("\n");
  return 1;
}

int stop_advertising_hashes() {
  int err;
  /* disable advertising */
  le_set_advertise_enable_cp enable = {0};
  enable.enable = 0;

  err = hci_send_cmd(handle, OGF_LE_CTL, OCF_LE_SET_ADVERTISE_ENABLE, sizeof(enable), &enable);
  if (err < 0) {
    perror("failed to disable LE advertising");
    hci_close_dev(handle);
    return 0;
  }
  printf("LE advertising disabled!\n");
  return 1;
}

