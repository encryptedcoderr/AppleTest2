#include <pcap/pcap.h>
#include <stdio.h>
#include <string.h>
#include <time.h>
#include "awdl_structs.h"

// Function to check if the packet is an AWDL frame
int is_awdl_frame(const unsigned char *bytes) {
    struct ieee80211_hdr *hdr = (struct ieee80211_hdr *)(bytes + sizeof(struct ieee80211_radiotap_header_compat));
    struct awdl_action *action = (struct awdl_action *)(hdr + 1);

    if ((hdr->frame_control & (IEEE80211_FCTL_FTYPE | IEEE80211_FCTL_STYPE)) == 
        (IEEE80211_FTYPE_MGMT | IEEE80211_STYPE_ACTION) &&
        action->category == IEEE80211_VENDOR_SPECIFIC &&
        // Changed from awdl_oui to awdl_bssid
        memcmp(&action->oui, &awdl_bssid, sizeof(awdl_bssid)) == 0 &&
        action->type == AWDL_TYPE &&
        action->version == AWDL_VERSION_COMPAT) {
        return 1;
    }
    return 0;
}


void log_awdl_info(unsigned char* user, const struct pcap_pkthdr *h, const unsigned char *bytes) {
    if (!is_awdl_frame(bytes)) return;

    FILE *logfile = fopen("awdl_info.log", "a");
    if (logfile == NULL) {
        perror("Unable to open log file");
        return;
    }

    // Print timestamp
    time_t now = time(NULL);
    char* dt = ctime(&now);
    fprintf(logfile, "AWDL Frame Received - %s", dt);

    // Log detailed information about the frame
    struct ieee80211_hdr *hdr = (struct ieee80211_hdr *)(bytes + sizeof(struct ieee80211_radiotap_header_compat));
    struct awdl_action *action = (struct awdl_action *)(hdr + 1);

    fprintf(logfile, "Source MAC: %s\n", ether_ntoa(&hdr->src_addr));
    fprintf(logfile, "Destination MAC: %s\n", ether_ntoa(&hdr->dst_addr));
    fprintf(logfile, "AWDL Subtype: 0x%02x\n", action->subtype);
    fprintf(logfile, "PHY TX Timestamp: %u\n", action->phy_tx);
    fprintf(logfile, "Target TX Timestamp: %u\n", action->target_tx);

    // Here you might want to parse further TLVs or other data within the AWDL frame
    // This is just an example of basic logging
    fprintf(logfile, "-----------------------------------\n");
    fclose(logfile);
}

int main() {
    char *interface = "wlan3";
    char errbuf[PCAP_ERRBUF_SIZE];
    pcap_t *handle = pcap_open_live(interface, BUFSIZ, 1, 1000, errbuf);
    if (handle == NULL) {
        fprintf(stderr, "Couldn't open device %s: %s\n", interface, errbuf);
        return 2;
    }

    // Assuming awdl_oui is defined somewhere, possibly in awdl_structs.h
    // const struct oui awdl_oui = {0x00, 0x17, 0xf2};

    pcap_loop(handle, 0, log_awdl_info, NULL);
    pcap_close(handle);
    return 0;
}