//gcc -o change_mac_nl change_mac_nl.c -I/usr/include/libnl3 -lnl-3 -lnl-genl-3 -lnl-route-3

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <net/if.h>

#include <netinet/ether.h>
#include <netlink/netlink.h>
#include <netlink/route/link.h>
#include <netlink/socket.h>

#include <linux/netlink.h>

#include <netlink/object-api.h>
#include <netlink/route/addr.h>
#include <netlink/route/rtnl.h>

int main(int argc, char** argv) {
    int err;

    struct nl_cache* link_cache;

    struct nl_sock* sk = nl_socket_alloc();
    if (!sk) {
        printf("unable to allocate netlink socket\n");
        return 0;
    }

    err = nl_connect(sk, NETLINK_ROUTE);
    if (err < 0) {
        printf("unable to connect socket\n");
        return 0;
    }

    struct rtnl_link* new = rtnl_link_alloc();
    if (!new) {
        printf("link allocation failed\n");
        return 0;
    }

    err = rtnl_link_alloc_cache(sk, NETLINK_ROUTE, &link_cache);
    if (err < 0) {
        nl_perror(err, "unable to allocate cache\n");
        return 0;
    }

/*
    int index = rtnl_link_name2i(link_cache, "wlan2");
    if (!index) {
        printf("failed to look up interface\n");
        return 0;
    }
    
    // should we do nl_cache_refill here?
    struct rtnl_link* old = rtnl_link_get(link_cache, index);
*/
    uint8_t mac[6] = {0x22, 0x23, 0x24, 0x00, 0x00, 0x08};

    struct nl_addr* addr = nl_addr_build(AF_LLC, (void*)mac, ETH_ALEN);
    if (!addr) {
        printf("failed to allocate addr\n");
        return 0;
    }

    struct rtnl_link* old = rtnl_link_get_by_name(link_cache, "wlan1");

    struct rtnl_link* updown = rtnl_link_alloc();
    rtnl_link_unset_flags(updown, IFF_UP);
///*
    err = rtnl_link_change(sk, old, updown, 0);
    if (err < 0) {
        nl_perror(err, "failed to bring interface down");
        return 0;
    }
//*/
    rtnl_link_set_addr(new, addr);

    nl_addr_put(addr);

    err = rtnl_link_change(sk, old, new, 0);
    if (err != 0) {
        nl_perror(err, "failed to change link address\n");
        return 0;
    }
///*
    // bring interface back up
    rtnl_link_set_flags(updown, IFF_UP);
    err = rtnl_link_change(sk, old, updown, 0);
    if (err < 0) {
        nl_perror(err, "failed to bring interface up");
        return 0;
    }
//*/

    rtnl_link_put(old);

    return 0;
}
