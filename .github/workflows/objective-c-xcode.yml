// ==UserScript==
// @name         GitHub Automation
// @namespace    http://tampermonkey.net/
// @version      1.6
// @description  Automates GitHub file edits, commits, navigates to Actions, with Back button to workflow
// @author       You
// @match        https://*.github.com/*
// @include      https://github.com/*
// @run-at       document-end
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  // Automation function
  async function runAutomation() {
    try {
      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }

      console.log('üîÑ Starting automation...');

      // 1. Find and click edit icon
      console.log('üîç Finding edit icon...');
      let pencilIcon;
      for (let i = 0; i < 5; i++) {
        pencilIcon = document.querySelector('svg.octicon-pencil, [data-testid="edit-button"], [aria-label*="edit"]');
        if (pencilIcon) break;
        console.log('‚è≥ Edit icon not found, retrying...');
        await sleep(1000);
      }
      if (!pencilIcon) {
        console.error('Error: Edit icon not found. Ensure you‚Äôre on the file view page.');
        return;
      }
      const clickableParent = pencilIcon.closest('a, button, [role="button"], [data-action]');
      if (!clickableParent) {
        console.error('Error: Edit icon found, but no clickable parent.');
        return;
      }
      console.log('üñ±Ô∏è Clicking edit icon...');
      clickableParent.click();

      console.log('‚è≥ Waiting for editor...');
      await sleep(3000);

      // 2. Find and clear editor
      let editorContent;
      for (let i = 0; i < 5; i++) {
        editorContent = document.querySelector('div.cm-content, [contenteditable="true"], textarea[name*="content"]');
        if (editorContent) break;
        console.log('‚è≥ Editor not found, retrying...');
        await sleep(1000);
      }
      if (!editorContent) {
        console.error('Error: Editor content area not found.');
        return;
      }
      console.log('üßπ Clearing editor...');
      editorContent.innerText = '';

      console.log('üìã Pasting from clipboard...');

      // 3. Paste clipboard content
      try {
        const clipboardText = await navigator.clipboard.readText();
        if (clipboardText) {
          console.log('üì• Pasting clipboard content...');
          editorContent.innerText = clipboardText;
        } else {
          console.warn('Warning: Clipboard empty.');
        }
      } catch (err) {
        console.error('Error: Clipboard access failed. Check permissions.', err);
        return;
      }

      console.log('‚è≥ Waiting 3 seconds before commit...');
      await sleep(3000);

      // 4. Click "Commit changes..." button
      console.log('üîç Finding "Commit changes..." button...');
      let commitButton;
      for (let i = 0; i < 5; i++) {
        commitButton = Array.from(document.querySelectorAll('button')).find(b =>
          b.textContent.trim().includes('Commit changes')
        );
        if (commitButton) break;
        console.log('‚è≥ Commit button not found, retrying...');
        await sleep(1000);
      }
      if (!commitButton) {
        console.error('Error: Could not find the "Commit changes..." button.');
        return;
      }
      console.log('üñ±Ô∏è Clicking "Commit changes..."...');
      commitButton.click();

      console.log('‚è≥ Waiting 2 seconds for confirmation dialog...');
      await sleep(2000);

      // 5. Click final "Commit changes" button
      console.log('üîç Finding final "Commit changes" button...');
      let confirmButton;
      for (let i = 0; i < 5; i++) {
        confirmButton = Array.from(document.querySelectorAll('button')).find(b =>
          b.textContent.trim() === 'Commit changes'
        );
        if (confirmButton) break;
        console.log('‚è≥ Final commit button not found, retrying...');
        await sleep(1000);
      }
      if (!confirmButton) {
        console.error('Error: Could not find the final "Commit changes" button.');
        return;
      }
      console.log('üñ±Ô∏è Clicking final "Commit changes" button...');
      confirmButton.click();
      console.log('‚úÖ Commit confirmed!');

      // 6. Disable "Leave site?" prompt
      console.log('üîß Disabling "Leave site?" confirmation...');
      window.onbeforeunload = null;

      // 7. Navigate to Actions page
      const repoPath = window.location.pathname.split('/').slice(0, 3).join('/');
      const targetUrl = `${window.location.origin}${repoPath}/actions`;
      console.log(`üöÄ Navigating to ${targetUrl}...`);
      await sleep(100);
      window.location.href = targetUrl;
    } catch (e) {
      console.error('Automation failed:', e);
      alert('Automation failed. Check console (F12) for details.');
    }
  }

  // Function to create UI
  function createUI() {
    try {
      // Prevent duplicate UI
      if (document.getElementById('custom-script-executor-container')) {
        console.log('Executor box already exists.');
        return;
      }

      // --- UI Creation ---
      const container = document.createElement('div');
      container.id = 'custom-script-executor-container';
      Object.assign(container.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        zIndex: '9999',
        backgroundColor: '#24292f',
        color: '#c9d1d9',
        border: '1px solid #444c56',
        borderRadius: '8px',
        padding: '16px',
        boxShadow: '0 8px 24px rgba(0,0,0,0.4)',
        fontFamily: 'sans-serif',
        width: '400px'
      });

      const title = document.createElement('h3');
      title.textContent = 'Automation Control';
      Object.assign(title.style, {
        margin: '0 0 10px 0',
        fontSize: '16px',
        borderBottom: '1px solid #444c56',
        paddingBottom: '8px'
      });

      const instructions = document.createElement('p');
      instructions.textContent = 'Automation runs on page load. Click "Run Automation" to re-run or "Back" to view workflow.';
      Object.assign(instructions.style, {
        margin: '0 0 10px 0',
        fontSize: '14px'
      });

      const runButton = document.createElement('button');
      runButton.textContent = 'Run Automation';
      Object.assign(runButton.style, {
        width: '100%',
        padding: '10px',
        border: '1px solid #388bfd',
        borderRadius: '6px',
        backgroundColor: '#238636',
        color: 'white',
        cursor: 'pointer',
        fontWeight: 'bold',
        marginBottom: '10px'
      });
      runButton.onmouseover = () => (runButton.style.backgroundColor = '#2ea043');
      runButton.onmouseout = () => (runButton.style.backgroundColor = '#238636');

      const backButton = document.createElement('button');
      backButton.textContent = 'Back';
      Object.assign(backButton.style, {
        width: '100%',
        padding: '10px',
        border: '1px solid #388bfd',
        borderRadius: '6px',
        backgroundColor: '#d73a49',
        color: 'white',
        cursor: 'pointer',
        fontWeight: 'bold'
      });
      backButton.onmouseover = () => (backButton.style.backgroundColor = '#cb2431');
      backButton.onmouseout = () => (backButton.style.backgroundColor = '#d73a49');

      const closeButton = document.createElement('button');
      closeButton.textContent = 'X';
      Object.assign(closeButton.style, {
        position: 'absolute',
        top: '10px',
        right: '10px',
        background: 'transparent',
        border: 'none',
        color: '#8b949e',
        fontSize: '16px',
        cursor: 'pointer'
      });

      // --- Button Logic ---
      runButton.onclick = () => {
        console.log('üöÄ Running automation manually...');
        runAutomation();
      };

      backButton.onclick = () => {
        console.log('üîô Navigating to workflow run...');
        window.location.href = 'https://github.com/encryptedcoderr/AppleTest2/actions/runs/15549379932/workflow';
      };

      closeButton.onclick = () => container.remove();

      // Assemble UI
      container.appendChild(closeButton);
      container.appendChild(title);
      container.appendChild(instructions);
      container.appendChild(runButton);
      container.appendChild(backButton);
      document.body.appendChild(container);
      console.log('üõ†Ô∏è Automation control box created.');

      // Run automation automatically
      runAutomation();
    } catch (e) {
      console.error('Error creating UI:', e);
    }
  }

  // Run after DOM is ready
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    createUI();
  } else {
    document.addEventListener('DOMContentLoaded', createUI);
  }

  // Handle SPA navigation
  let lastPath = window.location.pathname;
  setInterval(() => {
    if (window.location.pathname !== lastPath) {
      lastPath = window.location.pathname;
      createUI();
      // Optional: Re-run automation on SPA navigation
      // runAutomation();
    }
  }, 1000);
})();
