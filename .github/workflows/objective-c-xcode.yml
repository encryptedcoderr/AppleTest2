# This workflow uses the Google Project Zero CoreAudioFuzz tool to find
# double-free and other memory corruption vulnerabilities in macOS audio services.
# It sets up the environment, runs the fuzzer, and traces relevant daemons
# to capture a full diagnostic picture.

name: CoreAudio Double-Free Fuzzing
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allows manual triggering

jobs:
  fuzz-coreaudio:
    runs-on: macos-latest

    steps:
      # Step 1: Clone the p0tools repository which contains the CoreAudioFuzz tool.
      - name: Clone p0tools Repository
        run: |
          echo "[*] Cloning Google Project Zero's p0tools..."
          git clone https://github.com/googleprojectzero/p0tools.git
          echo "✅ Repository cloned."

      # Step 2: Add debugging to verify file paths.
      - name: Verify Cloned Files
        run: |
          echo "[*] Verifying the contents of the p0tools directory..."
          ls -lR p0tools/CoreAudioFuzz

      # Step 3: Install Python dependencies for the fuzzer.
      - name: Install Fuzzer Dependencies
        run: |
          echo "[*] Installing 'six' library for CoreAudioFuzz..."
          # Use --break-system-packages to handle externally managed Python environments.
          pip3 install --break-system-packages six
          echo "✅ Dependencies installed."

      # Step 4: Create the main session script to orchestrate the fuzzing and tracing.
      - name: Create Fuzzing Session Script
        run: |
          echo "Creating run_fuzz_session.sh script..."
          cat > run_fuzz_session.sh << 'EOF'
          #!/bin/bash
          if [ "$EUID" -ne 0 ]; then echo "Please run with sudo."; exit 1; fi

          LOG_DIR="coreaudio_fuzz_logs"
          mkdir -p $LOG_DIR && rm -f $LOG_DIR/*
          echo "--- CoreAudio Fuzzing Session Started: $(date) ---" | tee $LOG_DIR/session.log

          # --- Tracing Setup ---
          echo "[*] Starting system call trace on coreaudiod..."
          COREAUDIO_PID=$(pgrep -x coreaudiod || echo "")
          if [ -n "$COREAUDIO_PID" ]; then
              sudo dtruss -p $COREAUDIO_PID -f -d > "$LOG_DIR/dtruss_coreaudiod.log" 2>&1 &
              DTRUSS_PID=$!
              echo "    dtruss attached to coreaudiod (PID $COREAUDIO_PID)."
          else
              echo "⚠️ coreaudiod not found. Tracing may be incomplete."
          fi
          
          # --- Fuzzing Logic ---
          FUZZER_PATH="./p0tools/CoreAudioFuzz/fuzz_CoreAudio.py"
          if [ ! -f "$FUZZER_PATH" ]; then
              echo "❌ Fuzzer script not found at $FUZZER_PATH"
              exit 1
          fi
          
          echo "[*] Launching CoreAudioFuzz for 90 seconds..."
          # The fuzzer will automatically find and test available services.
          # We now explicitly use python3.
          sudo python3 $FUZZER_PATH > "$LOG_DIR/fuzzer_output.log" 2>&1 &
          FUZZER_PID=$!
          
          sleep 90

          echo "[*] Stopping fuzzer and tracers..."
          sudo kill $FUZZER_PID || true
          sudo pkill -f dtruss || true
          
          echo "✅ Fuzzing session complete. Logs are in '$LOG_DIR'."
          # Check for any generated crash reports, which are the primary indicator of success.
          echo "[*] Checking for crash reports..."
          CRASH_REPORTS=$(ls /Library/Logs/DiagnosticReports/*_$(date +%Y-%m-%d)*.crash 2>/dev/null)
          if [ -n "$CRASH_REPORTS" ]; then
              echo "🚨 SUCCESS: Crash reports found! Copying to logs directory."
              sudo cp $CRASH_REPORTS $LOG_DIR/
          else
              echo "    No new crash reports found."
          fi

          ls -l $LOG_DIR
          EOF
          chmod +x run_fuzz_session.sh

      # Step 5: Execute the fuzzing session.
      - name: Run Fuzzing and Tracing Session
        run: sudo ./run_fuzz_session.sh

      # Step 6: Upload all captured logs and crash reports as an artifact.
      - name: Upload Fuzzing Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coreaudio-fuzzing-logs
          path: coreaudio_fuzz_logs/
          retention-days: 7
